<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi Thử THPT Quốc Gia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --secondary: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --math: #3b82f6;
            --literature: #ef4444;
            --english: #10b981;
            --physics: #8b5cf6;
            --chemistry: #ec4899;
            --biology: #84cc16;
            --history: #f59e0b;
            --geography: #06b6d4;
            --civic: #64748b;
        }
        
        body {
            font-family: 'Noto Serif', serif;
            background-color: #f1f5f9;
            color: #334155;
            line-height: 1.6;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        .exam-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .exam-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .question-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .timer-container {
            background-color: white;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--primary);
        }
        
        .timer-warning {
            color: var(--warning);
            animation: pulse 1s infinite;
        }
        
        .timer-danger {
            color: var(--danger);
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .section-title {
            position: relative;
            padding-bottom: 8px;
            margin-bottom: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .section-title:after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 50px;
            height: 3px;
            background-color: var(--primary);
            border-radius: 3px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25);
        }
        
        .btn-secondary:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.3);
        }
        
        .answer-input {
            min-height: 100px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            font-family: 'Noto Serif', serif;
        }
        
        .answer-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        
        .result-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .result-header {
            padding: 1rem 1.5rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-good {
            border-left: 4px solid var(--success);
        }
        
        .result-good .result-header {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .result-medium {
            border-left: 4px solid var(--warning);
        }
        
        .result-medium .result-header {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .result-low {
            border-left: 4px solid var(--danger);
        }
        
        .result-low .result-header {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .result-body {
            padding: 1.5rem;
        }
        
        .highlight {
            background-color: #fff9c4;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.5s ease;
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .floating-action-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .tooltip {
            position: relative;
        }
        
        .tooltip:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            min-width: 150px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .tooltip:after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: var(--dark) transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 4px;
        }
        
        .tooltip:hover:before, .tooltip:hover:after {
            opacity: 1;
            visibility: visible;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 2rem;
        }
        
        .improvement-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .improvement-up {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .improvement-down {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .improvement-neutral {
            background-color: rgba(156, 163, 175, 0.1);
            color: var(--gray);
        }
        
        .streak-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        
        .streak-box {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .streak-icon {
            margin-right: 0.5rem;
            color: #d32f2f;
        }
        
        .streak-count {
            font-weight: 700;
            color: #d32f2f;
            margin-right: 0.25rem;
        }
        
        .streak-text {
            font-weight: 500;
            color: #d32f2f;
        }
        
        /* Subject colors */
        .subject-math { color: var(--math); }
        .subject-literature { color: var(--literature); }
        .subject-english { color: var(--english); }
        .subject-physics { color: var(--physics); }
        .subject-chemistry { color: var(--chemistry); }
        .subject-biology { color: var(--biology); }
        .subject-history { color: var(--history); }
        .subject-geography { color: var(--geography); }
        .subject-civic { color: var(--civic); }
        
        .bg-subject-math { background-color: var(--math); }
        .bg-subject-literature { background-color: var(--literature); }
        .bg-subject-english { background-color: var(--english); }
        .bg-subject-physics { background-color: var(--physics); }
        .bg-subject-chemistry { background-color: var(--chemistry); }
        .bg-subject-biology { background-color: var(--biology); }
        .bg-subject-history { background-color: var(--history); }
        .bg-subject-geography { background-color: var(--geography); }
        .bg-subject-civic { background-color: var(--civic); }
        
        .border-subject-math { border-color: var(--math); }
        .border-subject-literature { border-color: var(--literature); }
        .border-subject-english { border-color: var(--english); }
        .border-subject-physics { border-color: var(--physics); }
        .border-subject-chemistry { border-color: var(--chemistry); }
        .border-subject-biology { border-color: var(--biology); }
        .border-subject-history { border-color: var(--history); }
        .border-subject-geography { border-color: var(--geography); }
        .border-subject-civic { border-color: var(--civic); }
        
        .subject-selector {
            transition: all 0.3s ease;
        }
        
        .subject-selector:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .subject-selector.active {
            border: 3px solid var(--primary);
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .floating-action-btn {
                bottom: 1rem;
                right: 1rem;
                width: 50px;
                height: 50px;
            }
            
            .streak-box {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="header-gradient text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">THI THỬ THPT QUỐC GIA</h1>
                    <p class="text-sm md:text-base opacity-90 mt-1">Luyện tập - Nâng cao kỹ năng - Đạt điểm cao</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="user-info" class="hidden items-center space-x-2">
                        <span id="user-name" class="font-medium"></span>
                        <button id="logout-btn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm transition">
                            Đăng xuất
                        </button>
                    </div>
                    <div id="login-btn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm transition cursor-pointer">
                        Đăng nhập
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Start Screen -->
        <div id="start-screen" class="max-w-6xl mx-auto">
            <div class="exam-card p-8 text-center">
                <div class="flex justify-center mb-6">
                    <div class="bg-blue-100 p-4 rounded-full inline-block">
                        <i class="fas fa-graduation-cap text-4xl text-blue-600"></i>
                    </div>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">Chào mừng đến với hệ thống thi thử THPT Quốc Gia</h2>
                <p class="text-gray-600 mb-8">Ôn luyện với đề thi mô phỏng chính thức kỳ thi THPT Quốc Gia</p>
                
                <!-- Chuỗi lửa (streak) -->
                <div class="streak-container">
                    <div id="streak-display" class="streak-box hidden">
                        <i class="fas fa-fire streak-icon"></i>
                        <span id="streak-count" class="streak-count">0</span>
                        <span class="streak-text">ngày thi liên tiếp</span>
                    </div>
                </div>
                
                <!-- Chọn môn thi -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Chọn môn thi</h3>
                    <div class="subject-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Toán -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-math cursor-pointer" data-subject="math">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-math text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-square-root-alt text-xl"></i>
                                </div>
                                <span class="font-bold subject-math">Toán</span>
                                <span class="text-xs text-gray-500">90 phút</span>
                            </div>
                        </div>
                        
                        <!-- Ngữ Văn -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-literature cursor-pointer" data-subject="literature">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-literature text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-book-open text-xl"></i>
                                </div>
                                <span class="font-bold subject-literature">Ngữ Văn</span>
                                <span class="text-xs text-gray-500">120 phút</span>
                            </div>
                        </div>
                        
                        <!-- Tiếng Anh -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-english cursor-pointer" data-subject="english">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-english text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-language text-xl"></i>
                                </div>
                                <span class="font-bold subject-english">Tiếng Anh</span>
                                <span class="text-xs text-gray-500">60 phút</span>
                            </div>
                        </div>
                        
                        <!-- Vật Lý -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-physics cursor-pointer" data-subject="physics">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-physics text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-atom text-xl"></i>
                                </div>
                                <span class="font-bold subject-physics">Vật Lý</span>
                                <span class="text-xs text-gray-500">50 phút</span>
                            </div>
                        </div>
                        
                        <!-- Hóa Học -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-chemistry cursor-pointer" data-subject="chemistry">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-chemistry text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-flask text-xl"></i>
                                </div>
                                <span class="font-bold subject-chemistry">Hóa Học</span>
                                <span class="text-xs text-gray-500">50 phút</span>
                            </div>
                        </div>
                        
                        <!-- Sinh Học -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-biology cursor-pointer" data-subject="biology">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-biology text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-dna text-xl"></i>
                                </div>
                                <span class="font-bold subject-biology">Sinh Học</span>
                                <span class="text-xs text-gray-500">50 phút</span>
                            </div>
                        </div>
                        
                        <!-- Lịch Sử -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-history cursor-pointer" data-subject="history">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-history text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-landmark text-xl"></i>
                                </div>
                                <span class="font-bold subject-history">Lịch Sử</span>
                                <span class="text-xs text-gray-500">50 phút</span>
                            </div>
                        </div>
                        
                        <!-- Địa Lý -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-geography cursor-pointer" data-subject="geography">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-geography text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-globe-americas text-xl"></i>
                                </div>
                                <span class="font-bold subject-geography">Địa Lý</span>
                                <span class="text-xs text-gray-500">50 phút</span>
                            </div>
                        </div>
                        
                        <!-- GDCD -->
                        <div class="subject-selector bg-white p-4 rounded-lg shadow-md border-2 border-subject-civic cursor-pointer" data-subject="civic">
                            <div class="flex flex-col items-center">
                                <div class="bg-subject-civic text-white p-3 rounded-full mb-2">
                                    <i class="fas fa-balance-scale text-xl"></i>
                                </div>
                                <span class="font-bold subject-civic">GDCD</span>
                                <span class="text-xs text-gray-500">50 phút</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-8">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="flex items-center">
                            <i class="fas fa-clock text-gray-500 mr-2"></i>
                            <span class="font-medium">Thời gian: <span id="selected-exam-time" class="text-blue-600">Chọn môn để xem thời gian</span></span>
                        </div>
                        <div class="h-4 w-px bg-gray-300"></div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-gray-500 mr-2"></i>
                            <span class="font-medium">Tự động chấm điểm</span>
                        </div>
                    </div>
                </div>
                
                <button id="start-exam-btn" class="btn-primary px-8 py-3 text-lg inline-flex items-center" disabled>
                    <i class="fas fa-play mr-2"></i> Bắt đầu thi
                </button>
            </div>
            
            <!-- Lịch sử thi (hiển thị ngay từ đầu) -->
            <div class="exam-card p-6 md:p-8 mt-8" id="history-section">
                <h3 class="section-title">LỊCH SỬ THI</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Môn thi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày thi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm số</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đánh giá</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiến bộ</th>
                            </tr>
                        </thead>
                        <tbody id="history-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center">Đăng nhập để xem lịch sử thi</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="chart-container">
                    <canvas id="progress-chart"></canvas>
                </div>
            </div>
            
            <div class="mt-8 grid md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex items-center mb-3">
                        <div class="bg-purple-100 p-2 rounded-full mr-3">
                            <i class="fas fa-lightbulb text-purple-600"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Mẹo làm bài</h3>
                    </div>
                    <p class="text-gray-600 text-sm">Đọc kỹ đề bài, phân bổ thời gian hợp lý và kiểm tra lại bài trước khi nộp.</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex items-center mb-3">
                        <div class="bg-green-100 p-2 rounded-full mr-3">
                            <i class="fas fa-chart-line text-green-600"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Theo dõi tiến độ</h3>
                    </div>
                    <p class="text-gray-600 text-sm">Hệ thống sẽ lưu lại kết quả các bài thi để bạn theo dõi sự tiến bộ.</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex items-center mb-3">
                        <div class="bg-red-100 p-2 rounded-full mr-3">
                            <i class="fas fa-bell text-red-600"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">Nhắc nhở</h3>
                    </div>
                    <p class="text-gray-600 text-sm">Hệ thống sẽ tự động nộp bài khi hết giờ làm bài.</p>
                </div>
            </div>
        </div>
        
        <!-- Exam Screen -->
        <div id="exam-screen" class="max-w-6xl mx-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="exam-title" class="text-xl font-bold text-gray-800">ĐỀ THI THỬ MÔN <span id="exam-subject"></span></h2>
                    <p class="text-sm text-gray-500">Thời gian làm bài: <span id="exam-time-display"></span></p>
                </div>
                <div class="timer-container px-4 py-2">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-clock text-gray-500"></i>
                        <span id="timer" class="timer text-lg">120:00</span>
                    </div>
                </div>
            </div>
            
            <div id="exam-content">
                <!-- Nội dung đề thi sẽ được tạo động ở đây -->
            </div>
            
            <div class="mt-8 flex justify-center">
                <button id="submit-exam-btn" class="btn-primary px-8 py-3 text-lg inline-flex items-center">
                    <i class="fas fa-paper-plane mr-2"></i> Nộp bài
                </button>
            </div>
        </div>
        
        <!-- Result Screen -->
        <div id="result-screen" class="max-w-6xl mx-auto hidden">
            <div class="exam-card p-6 md:p-8 text-center mb-8">
                <div class="flex justify-center mb-6">
                    <div class="bg-green-100 p-4 rounded-full inline-block">
                        <i class="fas fa-award text-4xl text-green-600"></i>
                    </div>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold mb-2 text-gray-800">KẾT QUẢ BÀI THI <span id="result-subject" class="subject-math"></span></h2>
                <p class="text-gray-600 mb-6">Đây là kết quả bài làm của bạn cùng với nhận xét chi tiết</p>
                
                <div class="flex justify-center mb-8">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg w-full max-w-md">
                        <div class="text-sm mb-1">TỔNG ĐIỂM</div>
                        <div id="total-score" class="text-5xl font-bold mb-2">0.00</div>
                        <div id="score-feedback" class="text-sm"></div>
                        <div class="mt-4">
                            <div class="progress-bar">
                                <div id="score-progress" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="result-content" class="exam-card p-6 md:p-8 mb-8">
                <!-- Nội dung kết quả sẽ được tạo động ở đây -->
            </div>
            
            <!-- Lịch sử thi -->
            <div class="exam-card p-6 md:p-8 mb-8">
                <h3 class="section-title">LỊCH SỬ THI</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Môn thi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày thi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm số</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đánh giá</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiến bộ</th>
                            </tr>
                        </thead>
                        <tbody id="result-history-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center">Đang tải dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="chart-container">
                    <canvas id="result-progress-chart"></canvas>
                </div>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button id="retry-btn" class="btn-primary px-8 py-3 text-lg inline-flex items-center">
                    <i class="fas fa-redo mr-2"></i> Làm lại
                </button>
                <button id="new-exam-btn" class="btn-secondary px-8 py-3 text-lg inline-flex items-center">
                    <i class="fas fa-file-alt mr-2"></i> Đề mới
                </button>
            </div>
        </div>
    </main>

    <!-- Floating Action Button -->
    <div id="fab" class="floating-action-btn hidden tooltip" data-tooltip="Lên đầu trang">
        <i class="fas fa-arrow-up text-xl"></i>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-2">Hệ thống thi thử THPT Quốc Gia</p>
            <p class="text-gray-400 text-sm">© 2025 - Phát triển bởi Hoàng Minh Tuấn và Trương Viết Duy Chương</p>
        </div>
    </footer>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        
        // Khởi tạo Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAu4xlTa51eZrb9b2xhWKkbOv-L8gpPDPg",
            authDomain: "xta-tl.firebaseapp.com",
            projectId: "xta-tl",
            storageBucket: "xta-tl.appspot.com",
            messagingSenderId: "1049275322449",
            appId: "1:1049275322449:web:9ad1ed1986bb1712942870",
            measurementId: "G-MC2V2CK2XF"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Khởi tạo AI
        const API_KEY = "AIzaSyAcZaIvApX_UQKWZzP4uj2J1cCseZ_zkyk";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        
        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const examScreen = document.getElementById('exam-screen');
        const resultScreen = document.getElementById('result-screen');
        const startExamBtn = document.getElementById('start-exam-btn');
        const submitExamBtn = document.getElementById('submit-exam-btn');
        const retryBtn = document.getElementById('retry-btn');
        const newExamBtn = document.getElementById('new-exam-btn');
        const timer = document.getElementById('timer');
        const fab = document.getElementById('fab');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const streakDisplay = document.getElementById('streak-display');
        const streakCount = document.getElementById('streak-count');
        const subjectSelectors = document.querySelectorAll('.subject-selector');
        const selectedExamTime = document.getElementById('selected-exam-time');
        const examTitle = document.getElementById('exam-title');
        const examSubject = document.getElementById('exam-subject');
        const examTimeDisplay = document.getElementById('exam-time-display');
        const examContent = document.getElementById('exam-content');
        const resultSubject = document.getElementById('result-subject');
        const resultContent = document.getElementById('result-content');
        
        // Biến toàn cục
        let examData = null;
        let timeLeft = 0;
        let timerInterval = null;
        let userAnswers = {};
        let progressChart = null;
        let resultProgressChart = null;
        let currentStreak = 0;
        let selectedSubject = null;
        let examTimes = {
            math: 90,
            literature: 120,
            english: 60,
            physics: 50,
            chemistry: 50,
            biology: 50,
            history: 50,
            geography: 50,
            civic: 50
        };
        let subjectNames = {
            math: "Toán",
            literature: "Ngữ Văn",
            english: "Tiếng Anh",
            physics: "Vật Lý",
            chemistry: "Hóa Học",
            biology: "Sinh Học",
            history: "Lịch Sử",
            geography: "Địa Lý",
            civic: "GDCD"
        };
        
        // Xử lý đăng nhập/đăng xuất
        loginBtn.addEventListener('click', () => {
            window.location.href = 'login.html';
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.reload();
            });
        });

        // Kiểm tra trạng thái đăng nhập
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Đã đăng nhập
                userInfo.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                userName.textContent = user.email;
                
                // Load lịch sử thi và chuỗi lửa
                loadExamHistory(user.uid);
                loadStreak(user.uid);
            } else {
                // Chưa đăng nhập
                userInfo.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                streakDisplay.classList.add('hidden');
            }
        });

        // Chọn môn thi
        subjectSelectors.forEach(selector => {
            selector.addEventListener('click', () => {
                // Bỏ chọn tất cả
                subjectSelectors.forEach(s => s.classList.remove('active'));
                
                // Chọn môn này
                selector.classList.add('active');
                selectedSubject = selector.dataset.subject;
                
                // Cập nhật thời gian thi
                const time = examTimes[selectedSubject];
                selectedExamTime.textContent = `${time} phút`;
                
                // Kích hoạt nút bắt đầu thi
                startExamBtn.disabled = false;
            });
        });
        
        // Hàm load chuỗi lửa
        function loadStreak(userId) {
            db.collection('user_streaks').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        currentStreak = data.currentStreak || 0;
                        const lastExamDate = data.lastExamDate ? data.lastExamDate.toDate() : null;
                        
                        // Kiểm tra nếu lần thi cuối cùng là hôm qua thì giữ nguyên streak
                        // Nếu cách đây hơn 1 ngày thì reset streak
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (lastExamDate) {
                            const lastDate = new Date(lastExamDate);
                            lastDate.setHours(0, 0, 0, 0);
                            
                            const diffTime = today - lastDate;
                            const diffDays = diffTime / (1000 * 60 * 60 * 24);
                            
                            if (diffDays > 1) {
                                // Đã quá 1 ngày kể từ lần thi cuối, reset streak
                                currentStreak = 0;
                                updateStreakInFirestore(userId, 0);
                            }
                        }
                        
                        updateStreakDisplay();
                    } else {
                        // Chưa có dữ liệu streak
                        currentStreak = 0;
                        updateStreakDisplay();
                    }
                })
                .catch((error) => {
                    console.error("Lỗi khi tải chuỗi lửa:", error);
                    currentStreak = 0;
                    updateStreakDisplay();
                });
        }

        // Cập nhật hiển thị chuỗi lửa
        function updateStreakDisplay() {
            if (currentStreak > 0) {
                streakCount.textContent = currentStreak;
                streakDisplay.classList.remove('hidden');
            } else {
                streakDisplay.classList.add('hidden');
            }
        }

        // Cập nhật chuỗi lửa trong Firestore
        function updateStreakInFirestore(userId, newStreak) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            db.collection('user_streaks').doc(userId).set({
                currentStreak: newStreak,
                lastExamDate: today,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true })
            .catch((error) => {
                console.error("Lỗi khi cập nhật chuỗi lửa:", error);
            });
        }

        // Tăng chuỗi lửa khi hoàn thành bài thi
        function incrementStreak(userId) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            db.collection('user_streaks').doc(userId).get()
                .then((doc) => {
                    let newStreak = 1;
                    
                    if (doc.exists) {
                        const data = doc.data();
                        const lastExamDate = data.lastExamDate ? data.lastExamDate.toDate() : null;
                        
                        if (lastExamDate) {
                            const lastDate = new Date(lastExamDate);
                            lastDate.setHours(0, 0, 0, 0);
                            
                            const diffTime = today - lastDate;
                            const diffDays = diffTime / (1000 * 60 * 60 * 24);
                            
                            if (diffDays === 1) {
                                // Thi liên tiếp ngày hôm sau
                                newStreak = (data.currentStreak || 0) + 1;
                            } else if (diffDays === 0) {
                                // Đã thi hôm nay rồi, không tăng streak
                                newStreak = data.currentStreak || 0;
                            }
                            // Nếu diffDays > 1 thì giữ newStreak = 1 (đã reset)
                        }
                    }
                    
                    currentStreak = newStreak;
                    updateStreakDisplay();
                    updateStreakInFirestore(userId, newStreak);
                })
                .catch((error) => {
                    console.error("Lỗi khi tăng chuỗi lửa:", error);
                });
        }
        
        // Hàm load lịch sử thi
        function loadExamHistory(userId) {
            const historyBody = document.getElementById('history-body');
            const resultHistoryBody = document.getElementById('result-history-body');
            
            // Hiển thị loading
            if (historyBody) historyBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Đang tải dữ liệu...</td></tr>';
            if (resultHistoryBody) resultHistoryBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Đang tải dữ liệu...</td></tr>';
            
            db.collection('exam_results')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc')
                .limit(5)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        const emptyRow = '<tr><td colspan="5" class="px-6 py-4 text-center">Chưa có dữ liệu</td></tr>';
                        if (historyBody) historyBody.innerHTML = emptyRow;
                        if (resultHistoryBody) resultHistoryBody.innerHTML = emptyRow;
                        return;
                    }
                    
                    // Chuẩn bị dữ liệu cho bảng và biểu đồ
                    const historyData = [];
                    const chartLabels = [];
                    const chartData = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data.timestamp.toDate();
                        const dateStr = date.toLocaleDateString('vi-VN');
                        const timeStr = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                        const fullDateStr = `${dateStr} ${timeStr}`;
                        
                        historyData.push({
                            subject: data.examData.subject || "Không xác định",
                            date: fullDateStr,
                            score: data.totalScore,
                            feedback: getScoreFeedback(data.totalScore)
                        });
                    });
                    
                    // Đảo ngược thứ tự để hiển thị từ cũ đến mới
                    historyData.reverse();
                    
                    // Tạo dữ liệu cho biểu đồ
                    historyData.forEach((item, index) => {
                        chartLabels.push(`Lần ${index + 1}`);
                        chartData.push(item.score);
                    });
                    
                    // Hiển thị bảng lịch sử
                    if (historyBody) {
                        historyBody.innerHTML = '';
                        historyData.forEach((item, index) => {
                            const improvement = calculateImprovement(historyData, index);
                            const row = createHistoryRow(item, improvement);
                            historyBody.appendChild(row);
                        });
                        
                        // Vẽ biểu đồ tiến bộ
                        drawProgressChart(chartLabels, chartData);
                    }
                    
                    // Hiển thị bảng lịch sử trong màn hình kết quả
                    if (resultHistoryBody) {
                        resultHistoryBody.innerHTML = '';
                        historyData.forEach((item, index) => {
                            const improvement = calculateImprovement(historyData, index);
                            const row = createHistoryRow(item, improvement);
                            resultHistoryBody.appendChild(row);
                        });
                        
                        // Vẽ biểu đồ tiến bộ trong màn hình kết quả
                        drawResultProgressChart(chartLabels, chartData);
                    }
                })
                .catch((error) => {
                    console.error("Lỗi khi tải lịch sử:", error);
                    const errorRow = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-600">Có lỗi khi tải dữ liệu</td></tr>';
                    if (historyBody) historyBody.innerHTML = errorRow;
                    if (resultHistoryBody) resultHistoryBody.innerHTML = errorRow;
                });
        }

        // Tạo hàng trong bảng lịch sử
        function createHistoryRow(item, improvement) {
            const row = document.createElement('tr');
            
            let rowClass = '';
            if (item.score >= 8) rowClass = 'bg-green-50';
            else if (item.score >= 6) rowClass = 'bg-blue-50';
            else if (item.score >= 4) rowClass = 'bg-amber-50';
            else rowClass = 'bg-red-50';
            
            row.className = rowClass;
            
            let improvementBadge = '';
            if (improvement) {
                if (improvement > 0) {
                    improvementBadge = `<span class="improvement-badge improvement-up"><i class="fas fa-arrow-up mr-1"></i>${improvement}%</span>`;
                } else if (improvement < 0) {
                    improvementBadge = `<span class="improvement-badge improvement-down"><i class="fas fa-arrow-down mr-1"></i>${Math.abs(improvement)}%</span>`;
                } else {
                    improvementBadge = `<span class="improvement-badge improvement-neutral"><i class="fas fa-equals mr-1"></i>0%</span>`;
                }
            }
            
            // Thêm class màu theo môn học
            const subjectClass = `subject-${getSubjectKey(item.subject)}`;
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap font-bold ${subjectClass}">${item.subject}</td>
                <td class="px-6 py-4 whitespace-nowrap">${item.date}</td>
                <td class="px-6 py-4 whitespace-nowrap font-bold">${item.score.toFixed(1)}/10</td>
                <td class="px-6 py-4">${item.feedback}</td>
                <td class="px-6 py-4 whitespace-nowrap">${improvementBadge}</td>
            `;
            
            return row;
        }

        // Lấy key môn học từ tên
        function getSubjectKey(subjectName) {
            for (const key in subjectNames) {
                if (subjectNames[key] === subjectName) {
                    return key;
                }
            }
            return 'math'; // Mặc định nếu không tìm thấy
        }

        // Tính phần trăm tiến bộ
        function calculateImprovement(historyData, currentIndex) {
            if (currentIndex === 0) return null; // Không có dữ liệu trước đó để so sánh
            
            // Chỉ so sánh nếu cùng môn học
            if (historyData[currentIndex].subject !== historyData[currentIndex - 1].subject) return null;
            
            const currentScore = historyData[currentIndex].score;
            const previousScore = historyData[currentIndex - 1].score;
            
            if (previousScore === 0) return null; // Tránh chia cho 0
            
            const improvement = ((currentScore - previousScore) / previousScore) * 100;
            return Math.round(improvement * 10) / 10; // Làm tròn 1 chữ số thập phân
        }

        function getScoreFeedback(score) {
            if (score >= 8) return "Xuất sắc";
            if (score >= 6) return "Khá tốt";
            if (score >= 4) return "Trung bình";
            return "Cần cải thiện";
        }
        
        // Vẽ biểu đồ tiến bộ
        function drawProgressChart(labels, data) {
            const ctx = document.getElementById('progress-chart').getContext('2d');
            
            // Hủy biểu đồ cũ nếu tồn tại
            if (progressChart) {
                progressChart.destroy();
            }
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Điểm số',
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'BIỂU ĐỒ TIẾN BỘ',
                            font: {
                                size: 16,
                                family: "'Noto Serif', serif"
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Điểm: ${context.raw.toFixed(1)}/10`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Vẽ biểu đồ tiến bộ trong màn hình kết quả
        function drawResultProgressChart(labels, data) {
            const ctx = document.getElementById('result-progress-chart').getContext('2d');
            
            // Hủy biểu đồ cũ nếu tồn tại
            if (resultProgressChart) {
                resultProgressChart.destroy();
            }
            
            resultProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Điểm số',
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'BIỂU ĐỒ TIẾN BỘ',
                            font: {
                                size: 16,
                                family: "'Noto Serif', serif"
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Điểm: ${context.raw.toFixed(1)}/10`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Bắt đầu bài thi
        startExamBtn.addEventListener('click', async () => {
            if (!selectedSubject) {
                alert("Vui lòng chọn môn thi trước khi bắt đầu");
                return;
            }
            
            // Hiển thị loading
            startExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo đề thi...';
            startExamBtn.disabled = true;
            
            try {
                // Tạo đề thi bằng AI
                examData = await generateExam(selectedSubject);
                examData.subject = subjectNames[selectedSubject]; // Thêm tên môn học vào dữ liệu đề thi
                
                // Hiển thị đề thi
                displayExam(examData, selectedSubject);
                
                // Cập nhật thời gian thi
                timeLeft = examTimes[selectedSubject] * 60;
                
                // Bắt đầu đếm ngược
                startTimer();
                
                // Hiển thị nút FAB
                fab.classList.remove('hidden');
                
                // Chuyển sang màn hình thi
                startScreen.classList.add('hidden');
                examScreen.classList.remove('hidden');
                
                // Cuộn lên đầu trang
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error("Lỗi khi tạo đề thi:", error);
                alert("Có lỗi xảy ra khi tạo đề thi. Vui lòng thử lại.");
            } finally {
                startExamBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Bắt đầu thi';
                startExamBtn.disabled = false;
            }
        });
        
        // Nộp bài thi
        submitExamBtn.addEventListener('click', async () => {
            // Hiển thị loading
            submitExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang chấm điểm...';
            submitExamBtn.disabled = true;
            
            try {
                // Thu thập câu trả lời
                collectAnswers();
                
                // Chấm điểm bằng AI
                const result = await evaluateExam(examData, userAnswers, selectedSubject);
                
                // Hiển thị kết quả
                displayResults(result, selectedSubject);
                
                // Dừng đồng hồ
                stopTimer();
                
                // Chuyển sang màn hình kết quả
                examScreen.classList.add('hidden');
                resultScreen.classList.remove('hidden');
                
                // Load lại lịch sử thi nếu đã đăng nhập
                const user = auth.currentUser;
                if (user) {
                    loadExamHistory(user.uid);
                    incrementStreak(user.uid); // Tăng chuỗi lửa khi hoàn thành bài thi
                }
            } catch (error) {
                console.error("Lỗi khi chấm bài:", error);
                alert("Có lỗi xảy ra khi chấm bài. Vui lòng thử lại.");
            } finally {
                submitExamBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Nộp bài';
                submitExamBtn.disabled = false;
            }
        });
        
        // Làm lại bài thi với cùng đề
        retryBtn.addEventListener('click', () => {
            resultScreen.classList.add('hidden');
            examScreen.classList.remove('hidden');
            resetExam();
            
            // Cuộn lên đầu trang
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Làm bài thi với đề mới
        newExamBtn.addEventListener('click', async () => {
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            resetExam();
            
            // Cuộn lên đầu trang
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Nút FAB - Cuộn lên đầu trang
        fab.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Hiển thị nút FAB khi cuộn trang
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
            }
        });
        
        // Tạo đề thi bằng AI với prompt cụ thể cho từng môn
        async function generateExam(subject) {
            let prompt = '';
            
            switch(subject) {
                case 'math':
                    prompt = `
                        Tạo đề thi môn Toán THPT Quốc Gia gồm 50 câu hỏi trắc nghiệm với các dạng:
                        - Câu hỏi nhận biết (20%): Kiến thức cơ bản, công thức đơn giản
                        - Câu hỏi thông hiểu (30%): Yêu cầu hiểu bản chất vấn đề
                        - Câu hỏi vận dụng (30%): Áp dụng kiến thức giải quyết vấn đề
                        - Câu hỏi vận dụng cao (20%): Bài toán phức tạp, tư duy logic
                        
                        Cấu trúc đề thi:
                        1. Đại số và Giải tích (60%): Hàm số, Mũ-Logarit, Nguyên hàm-Tích phân, Số phức
                        2. Hình học (40%): Hình học không gian, Tọa độ Oxyz
                        
                        Mỗi câu hỏi phải có 4 lựa chọn A, B, C, D, chỉ có 1 đáp án đúng.
                        Độ khó tăng dần từ câu 1 đến câu 50.
                        
                        Ví dụ câu hỏi:
                        - Câu nhận biết: "Tập xác định của hàm số y = log2(x-1) là:"
                        - Câu thông hiểu: "Cho hàm số y = f(x) có đạo hàm f'(x) = x(x-1)(x+2). Hàm số đồng biến trên khoảng nào?"
                        - Câu vận dụng: "Tìm m để phương trình 4^x - 2^(x+1) + m = 0 có hai nghiệm phân biệt"
                        - Câu vận dụng cao: "Cho hình chóp S.ABCD có đáy là hình vuông cạnh a, SA vuông góc (ABCD), SA = a√3. Tính góc giữa (SBC) và (SCD)"
                        
                        Trả lời bằng JSON theo định dạng:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao",
                                    "topic": "Đại số/Hình học"
                                },
                                ...
                            ]
                        }
                    `;
                    break;
                    
                case 'literature':
                    prompt = `
                        Tạo đề thi môn Ngữ Văn THPT Quốc Gia theo cấu trúc:
                        
                        I. ĐỌC HIỂU (4 điểm)
                        - Một đoạn văn/đoạn thơ khoảng 150-200 từ, có thể trích từ tác phẩm văn học hoặc văn bản nghị luận
                        - 4 câu hỏi đọc hiểu về đoạn văn đó, mỗi câu 1 điểm:
                          1. Câu nhận biết: Xác định phương thức biểu đạt, phong cách ngôn ngữ
                          2. Câu thông hiểu: Hiểu nội dung, ý nghĩa đoạn văn
                          3. Câu vận dụng: Phân tích biện pháp tu từ, cách diễn đạt
                          4. Câu vận dụng cao: Liên hệ, đánh giá vấn đề
                        
                        II. LÀM VĂN (6 điểm)
                        - Câu 1 (2 điểm): Viết đoạn văn nghị luận xã hội khoảng 200 chữ về một tư tưởng đạo lý hoặc hiện tượng đời sống
                        - Câu 2 (4 điểm): Viết bài văn nghị luận văn học về một tác phẩm/tác giả trong chương trình
                        
                        Ví dụ:
                        - Đoạn đọc hiểu: Trích "Hồn Trương Ba, da hàng thịt" - Lưu Quang Vũ
                        - Câu 1: "Viết đoạn văn về sức mạnh của lòng nhân ái"
                        - Câu 2: "Phân tích vẻ đẹp hình tượng người lái đò trong 'Người lái đò sông Đà'"
                        
                        Trả lời bằng JSON:
                        {
                            "reading": {
                                "passage": "Đoạn văn/đoạn thơ...",
                                "questions": [
                                    {
                                        "number": 1,
                                        "content": "Nội dung câu hỏi",
                                        "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao"
                                    },
                                    ...
                                ]
                            },
                            "writing": {
                                "task1": "Đề bài câu 1...",
                                "task2": "Đề bài câu 2..."
                            }
                        }
                    `;
                    break;
                    
                case 'english':
                    prompt = `
                        Tạo đề thi môn Tiếng Anh THPT Quốc Gia gồm 50 câu hỏi trắc nghiệm với các phần:
                        1. Ngữ âm (4 câu): Chọn từ có cách phát âm/trọng âm khác
                        2. Ngữ pháp - Từ vựng (16 câu): Thì, mạo từ, giới từ, từ loại, từ đồng nghĩa-trái nghĩa
                        3. Chức năng giao tiếp (2 câu): Hội thoại ngắn
                        4. Kỹ năng đọc (15 câu): 
                           - Điền từ vào đoạn văn (5 câu)
                           - Đọc hiểu 2 bài (10 câu)
                        5. Kỹ năng viết (13 câu):
                           - Tìm lỗi sai (3 câu)
                           - Viết lại câu (5 câu)
                           - Kết hợp câu (5 câu)
                        
                        Ví dụ:
                        - Ngữ âm: "Chọn từ có phần gạch chân phát âm khác: A. cat, B. car, C. cake, D. city"
                        - Ngữ pháp: "She ___ to the cinema last night. A. goes, B. went, C. has gone, D. had gone"
                        - Đọc hiểu: Bài đọc về chủ đề môi trường với các câu hỏi chi tiết, suy luận
                        
                        Trả lời bằng JSON:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "part": "Phonetics/Grammar-Vocabulary/Communication/Reading/Writing"
                                },
                                ...
                            ]
                        }
                    `;
                    break;
                    
                case 'physics':
                    prompt = `
                        Tạo đề thi môn Vật Lý THPT Quốc Gia gồm 40 câu hỏi trắc nghiệm với các chủ đề:
                        1. Dao động cơ (8 câu)
                        2. Sóng cơ (6 câu)
                        3. Điện xoay chiều (8 câu)
                        4. Dao động và sóng điện từ (4 câu)
                        5. Sóng ánh sáng (6 câu)
                        6. Lượng tử ánh sáng (4 câu)
                        7. Hạt nhân nguyên tử (4 câu)
                        
                        Phân bổ mức độ:
                        - Nhận biết (25%): Lý thuyết cơ bản, công thức đơn giản
                        - Thông hiểu (35%): Hiểu bản chất hiện tượng
                        - Vận dụng (30%): Tính toán, giải quyết vấn đề
                        - Vận dụng cao (10%): Bài toán phức tạp, tổng hợp kiến thức
                        
                        Ví dụ:
                        - Câu nhận biết: "Đơn vị của cường độ dòng điện là: A. Vôn, B. Ampe, C. Ohm, D. Watt"
                        - Câu vận dụng: "Một con lắc lò xo có k=100N/m, m=1kg dao động với A=5cm. Tốc độ cực đại là?"
                        - Câu vận dụng cao: "Mạch RLC có L thay đổi, tìm L để URL max"
                        
                        Trả lời bằng JSON:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao",
                                    "topic": "Dao động cơ/Sóng cơ/..."
                                },
                                ...
                            ]
                        }
                    `;
                    break;
                    
                case 'chemistry':
                    prompt = `
                        Tạo đề thi môn Hóa Học THPT Quốc Gia gồm 40 câu hỏi trắc nghiệm với các chủ đề:
                        1. Hóa học vô cơ (12 câu)
                        2. Hóa học hữu cơ (12 câu)
                        3. Lý thuyết tổng hợp (8 câu)
                        4. Bài toán hóa học (8 câu)
                        
                        Phân bổ mức độ:
                        - Nhận biết (20%): Lý thuyết cơ bản, tính chất hóa học
                        - Thông hiểu (30%): Hiểu bản chất phản ứng, hiện tượng
                        - Vận dụng (35%): Bài toán tính toán, cân bằng phản ứng
                        - Vận dụng cao (15%): Bài toán phức tạp, tổng hợp nhiều kiến thức
                        
                        Ví dụ:
                        - Câu nhận biết: "Kim loại nào sau đây tác dụng với nước ở nhiệt độ thường? A. Fe, B. Cu, C. Na, D. Ag"
                        - Câu vận dụng: "Đốt cháy hoàn toàn 0,1 mol ancol X thu được 0,3 mol CO2. Số nhóm -OH trong X là?"
                        - Câu vận dụng cao: "Hỗn hợp X gồm Al, Fe3O4, CuO. Hòa tan X trong HNO3 dư thu được... (bài toán nhiều bước)"
                        
                        Trả lời bằng JSON:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao",
                                    "topic": "Hóa vô cơ/Hóa hữu cơ/..."
                                },
                                ...
                            ]
                        }
                    `;
                    break;
                    
                case 'biology':
                    prompt = `
                        Tạo đề thi môn Sinh Học THPT Quốc Gia gồm 40 câu hỏi trắc nghiệm với các chủ đề:
                        1. Di truyền và biến dị (16 câu)
                        2. Tiến hóa (6 câu)
                        3. Sinh thái học (8 câu)
                        4. Sinh học cơ thể (10 câu)
                        
                        Phân bổ mức độ:
                        - Nhận biết (20%): Khái niệm cơ bản, quá trình sinh học
                        - Thông hiểu (30%): Hiểu cơ chế, nguyên lý
                        - Vận dụng (35%): Giải thích hiện tượng, bài toán di truyền
                        - Vận dụng cao (15%): Bài toán phức tạp, tổng hợp kiến thức
                        
                        Ví dụ:
                        - Câu nhận biết: "Quá trình phiên mã xảy ra ở đâu? A. Tế bào chất, B. Nhân tế bào, C. Ribosome, D. Ty thể"
                        - Câu vận dụng: "Bố mẹ có kiểu gen AaBb x AaBb. Xác suất đời con có 2 tính trạng trội là?"
                        - Câu vận dụng cao: "Phả hệ về bệnh di truyền, xác định kiểu gen của cá thể III.5"
                        
                        Trả lời bằng JSON:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao",
                                    "topic": "Di truyền/Tiến hóa/..."
                                },
                                ...
                            ]
                        }
                    `;
                    break;
                    
                case 'history':
                    prompt = `
                        Tạo đề thi môn Lịch Sử THPT Quốc Gia gồm 40 câu hỏi trắc nghiệm với các chủ đề:
                        1. Lịch sử thế giới (12 câu)
                        2. Lịch sử Việt Nam (28 câu)
                        
                        Phân bổ mức độ:
                        - Nhận biết (25%): Sự kiện, mốc thời gian, nhân vật lịch sử
                        - Thông hiểu (35%): Nguyên nhân, hậu quả, ý nghĩa sự kiện
                        - Vận dụng (30%): So sánh, đánh giá, liên hệ
                        - Vận dụng cao (10%): Phân tích tổng hợp, bài học lịch sử
                        
                        Ví dụ:
                        - Câu nhận biết: "Chiến dịch Điện Biên Phủ kết thúc năm nào? A. 1954, B. 1945, C. 1975, D. 1930"
                        - Câu thông hiểu: "Nguyên nhân chính dẫn đến Chiến tranh lạnh là gì?"
                        - Câu vận dụng: "So sánh Cách mạng tháng 8-1945 và Chiến dịch Hồ Chí Minh 1975"
                        
                        Trả lời bằng JSON:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao",
                                    "topic": "Lịch sử thế giới/Lịch sử Việt Nam"
                                },
                                ...
                            ]
                        }
                    `;
                    break;
                    
                case 'geography':
                    prompt = `
                        Tạo đề thi môn Địa Lý THPT Quốc Gia gồm 40 câu hỏi trắc nghiệm với các chủ đề:
                        1. Địa lý tự nhiên (12 câu)
                        2. Địa lý dân cư (8 câu)
                        3. Địa lý kinh tế (12 câu)
                        4. Địa lý vùng kinh tế (8 câu)
                        
                        Phân bổ mức độ:
                        - Nhận biết (25%): Kiến thức cơ bản, đặc điểm địa lý
                        - Thông hiểu (35%): Hiểu mối quan hệ, quy luật địa lý
                        - Vận dụng (30%): Phân tích bảng số liệu, biểu đồ, atlas
                        - Vận dụng cao (10%): Giải quyết vấn đề phát triển kinh tế-xã hội
                        
                        Ví dụ:
                        - Câu nhận biết: "Dãy núi nào dài nhất Việt Nam? A. Hoàng Liên Sơn, B. Trường Sơn, C. Đông Triều, D. Bạch Mã"
                        - Câu vận dụng: "Cho bảng số liệu về GDP các vùng kinh tế, nhận xét nào đúng?"
                        - Câu vận dụng cao: "Giải pháp phát triển bền vững Đồng bằng sông Cửu Long trước biến đổi khí hậu"
                        
                        Trả lời bằng JSON:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao",
                                    "topic": "Địa lý tự nhiên/Địa lý kinh tế/..."
                                },
                                ...
                            ]
                        }
                    `;
                    break;
                    
                case 'civic':
                    prompt = `
                        Tạo đề thi môn GDCD THPT Quốc Gia gồm 40 câu hỏi trắc nghiệm với các chủ đề:
                        1. Pháp luật và đời sống (12 câu)
                        2. Công dân với các quyền tự do cơ bản (10 câu)
                        3. Công dân với các nghĩa vụ pháp lý (10 câu)
                        4. Công dân với phát triển kinh tế (8 câu)
                        
                        Phân bổ mức độ:
                        - Nhận biết (25%): Khái niệm pháp luật, quyền và nghĩa vụ cơ bản
                        - Thông hiểu (35%): Hiểu nội dung các quy định pháp luật
                        - Vận dụng (30%): Xử lý tình huống pháp lý thực tế
                        - Vận dụng cao (10%): Đánh giá, đề xuất giải pháp
                        
                        Ví dụ:
                        - Câu nhận biết: "Người từ đủ bao nhiêu tuổi phải chịu trách nhiệm hình sự? A. 14, B. 16, C. 18, D. 21"
                        - Câu vận dụng: "Tình huống: A vay tiền B không trả. B cần làm gì để đòi nợ hợp pháp?"
                        - Câu vận dụng cao: "Phân tích trách nhiệm pháp lý trong vụ tai nạn giao thông do uống rượu bia"
                        
                        Trả lời bằng JSON:
                        {
                            "questions": [
                                {
                                    "number": 1,
                                    "content": "Nội dung câu hỏi",
                                    "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"],
                                    "correctAnswer": "A",
                                    "type": "Nhận biết/Thông hiểu/Vận dụng/Vận dụng cao",
                                    "topic": "Pháp luật/Quyền công dân/..."
                                },
                                ...
                            ]
                        }
                    `;
                    break;
            }
            
            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            // Tìm và trích xuất JSON từ phản hồi
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}') + 1;
            const jsonString = text.substring(jsonStart, jsonEnd);
            
            return JSON.parse(jsonString);
        }
        
        // Hiển thị đề thi lên giao diện
        function displayExam(data, subject) {
            // Cập nhật tiêu đề
            examSubject.textContent = subjectNames[subject];
            examSubject.className = `subject-${subject}`;
            examTimeDisplay.textContent = `${examTimes[subject]} phút`;
            
            // Xóa nội dung cũ
            examContent.innerHTML = '';
            
            // Tạo nội dung đề thi tùy theo môn
            if (subject === 'literature') {
                // Ngữ Văn
                const readingSection = document.createElement('div');
                readingSection.className = 'exam-card p-6 md:p-8 mb-8';
                readingSection.innerHTML = `
                    <h3 class="section-title">I. ĐỌC HIỂU (4.0 điểm)</h3>
                    <div id="reading-passage" class="mb-6 italic bg-gray-50 p-4 rounded-lg text-gray-700">${data.reading.passage}</div>
                    <div id="reading-questions" class="space-y-4"></div>
                `;
                examContent.appendChild(readingSection);
                
                const questionsContainer = document.getElementById('reading-questions');
                data.reading.questions.forEach((question, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.className = 'question-card p-5';
                    questionElement.innerHTML = `
                        <p class="font-bold text-gray-700 mb-2"><span class="text-primary">Câu ${question.number}:</span> ${question.content}</p>
                        <textarea id="reading-answer-${question.number}" class="answer-input w-full mt-2" placeholder="Nhập câu trả lời của bạn..."></textarea>
                        <div class="text-xs text-gray-500 mt-1">Dạng câu hỏi: ${question.type}</div>
                    `;
                    questionsContainer.appendChild(questionElement);
                });
                
                const writingSection = document.createElement('div');
                writingSection.className = 'exam-card p-6 md:p-8';
                writingSection.innerHTML = `
                    <h3 class="section-title">II. LÀM VĂN (6.0 điểm)</h3>
                    <div class="question-card p-5 mb-6">
                        <p class="font-bold text-gray-700 mb-2"><span class="text-primary">Câu 1 (2.0 điểm):</span> ${data.writing.task1}</p>
                        <textarea id="answer-1" class="answer-input w-full mt-2" placeholder="Nhập câu trả lời của bạn..."></textarea>
                        <div class="text-xs text-gray-500 mt-1">Gợi ý: Viết đoạn văn khoảng 200 chữ</div>
                    </div>
                    
                    <div class="question-card p-5">
                        <p class="font-bold text-gray-700 mb-2"><span class="text-primary">Câu 2 (4.0 điểm):</span> ${data.writing.task2}</p>
                        <textarea id="answer-2" class="answer-input w-full mt-2" style="min-height: 200px;" placeholder="Nhập câu trả lời của bạn..."></textarea>
                        <div class="text-xs text-gray-500 mt-1">Gợi ý: Viết bài văn đầy đủ 3 phần (mở bài, thân bài, kết bài)</div>
                    </div>
                `;
                examContent.appendChild(writingSection);
            } else {
                // Các môn trắc nghiệm
                const questionList = document.createElement('div');
                questionList.className = 'exam-card p-6 md:p-8 mb-8 grid grid-cols-1 md:grid-cols-2 gap-6';
                
                data.questions.forEach((question, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.className = 'question-card p-5';
                    questionElement.innerHTML = `
                        <p class="font-bold text-gray-700 mb-2"><span class="text-primary">Câu ${question.number}:</span> ${question.content}</p>
                        <div class="space-y-2 mt-3">
                            ${question.options.map((option, i) => `
                                <div class="flex items-center">
                                    <input type="radio" id="q${question.number}-${i}" name="q${question.number}" value="${option.charAt(0)}" class="mr-2">
                                    <label for="q${question.number}-${i}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                        ${question.type ? `<div class="text-xs text-gray-500 mt-2">Dạng câu hỏi: ${question.type}</div>` : ''}
                        ${question.topic ? `<div class="text-xs text-gray-500 mt-1">Chủ đề: ${question.topic}</div>` : ''}
                    `;
                    questionList.appendChild(questionElement);
                });
                
                examContent.appendChild(questionList);
            }
        }
        
        // Bắt đầu đếm ngược
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    stopTimer();
                    alert("Hết giờ làm bài! Hệ thống sẽ tự động nộp bài.");
                    submitExamBtn.click();
                }
            }, 1000);
        }
        
        // Cập nhật hiển thị đồng hồ
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Đổi màu và hiệu ứng khi thời gian sắp hết
            timer.className = 'timer text-lg';
            if (timeLeft <= 300) { // 5 phút cuối
                timer.classList.add('timer-warning');
            }
            if (timeLeft <= 60) { // 1 phút cuối
                timer.classList.remove('timer-warning');
                timer.classList.add('timer-danger');
            }
        }
        
        // Dừng đồng hồ
        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        // Thu thập câu trả lời của thí sinh
        function collectAnswers() {
            userAnswers = {};
            
            if (selectedSubject === 'literature') {
                // Ngữ Văn
                userAnswers = {
                    reading: {},
                    writing: {
                        task1: '',
                        task2: ''
                    }
                };
                
                // Thu thập câu trả lời phần đọc hiểu
                examData.reading.questions.forEach(question => {
                    const answerElement = document.getElementById(`reading-answer-${question.number}`);
                    userAnswers.reading[question.number] = answerElement.value;
                });
                
                // Thu thập câu trả lời phần làm văn
                userAnswers.writing.task1 = document.getElementById('answer-1').value;
                userAnswers.writing.task2 = document.getElementById('answer-2').value;
            } else {
                // Các môn trắc nghiệm
                userAnswers.questions = [];
                
                examData.questions.forEach(question => {
                    const selectedOption = document.querySelector(`input[name="q${question.number}"]:checked`);
                    userAnswers.questions.push({
                        number: question.number,
                        answer: selectedOption ? selectedOption.value : null
                    });
                });
            }
        }
        
        // Chấm điểm bài thi bằng AI với prompt cụ thể cho từng môn
        async function evaluateExam(examData, userAnswers, subject) {
            let prompt = '';
            
            if (subject === 'literature') {
                prompt = `
                    Chấm điểm bài thi Ngữ Văn THPT Quốc Gia dựa trên:
                    
                    1. Đề thi:
                    ${JSON.stringify(examData, null, 2)}
                    
                    2. Bài làm của học sinh:
                    ${JSON.stringify(userAnswers, null, 2)}
                    
                    Yêu cầu chấm điểm:
                    - Đọc hiểu (4 điểm): Mỗi câu 1 điểm, đánh giá theo:
                      * Câu nhận biết: Chính xác phương thức biểu đạt, phong cách ngôn ngữ
                      * Câu thông hiểu: Hiểu đúng nội dung, ý nghĩa đoạn văn
                      * Câu vận dụng: Phân tích đúng biện pháp tu từ, cách diễn đạt
                      * Câu vận dụng cao: Liên hệ, đánh giá hợp lý, sâu sắc
                    
                    - Làm văn (6 điểm):
                      * Câu 1 (2 điểm): Đảm bảo cấu trúc đoạn văn, nội dung sâu sắc, dẫn chứng thuyết phục
                      * Câu 2 (4 điểm): Bố cục rõ ràng, luận điểm chặt chẽ, phân tích sâu, văn phong tốt
                    
                    - Đưa ra nhận xét ngắn gọn, khách quan cho từng câu
                    - Gợi ý cách cải thiện (nếu cần)
                    - Tính tổng điểm (thang 10)
                    - Đánh giá tổng quan về bài làm
                    
                    Trả lời bằng JSON:
                    {
                        "reading": {
                            "totalScore": 4.0,
                            "questions": [
                                {
                                    "number": 1,
                                    "score": 0.5,
                                    "feedback": "Nhận xét...",
                                    "improvement": "Gợi ý cải thiện..."
                                },
                                ...
                            ]
                        },
                        "writing": {
                            "task1": {
                                "score": 2.0,
                                "feedback": "Nhận xét...",
                                "improvement": "Gợi ý cải thiện..."
                            },
                            "task2": {
                                "score": 3.5,
                                "feedback": "Nhận xét...",
                                "improvement": "Gợi ý cải thiện..."
                            }
                        },
                        "totalScore": 9.5,
                        "overallFeedback": "Nhận xét tổng quan...",
                        "scorePercentage": 95
                    }
                `;
            } else {
                prompt = `
                    Chấm điểm bài thi ${subjectNames[subject]} THPT Quốc Gia dựa trên:
                    
                    1. Đề thi:
                    ${JSON.stringify(examData, null, 2)}
                    
                    2. Bài làm của học sinh:
                    ${JSON.stringify(userAnswers, null, 2)}
                    
                    Yêu cầu chấm điểm:
                    - Mỗi câu đúng được 0.25 điểm (tổng 10 điểm)
                    - Đưa ra nhận xét ngắn gọn về từng phần thi theo chủ đề
                    - Gợi ý cách cải thiện kiến thức còn yếu (nếu cần)
                    - Tính tổng điểm (làm tròn 1 chữ số thập phân)
                    - Đánh giá tổng quan về bài làm
                    
                    Trả lời bằng JSON:
                    {
                        "sections": [
                            {
                                "name": "Phần thi",
                                "score": 8.0,
                                "correct": 32,
                                "total": 40,
                                "feedback": "Nhận xét...",
                                "improvement": "Gợi ý cải thiện..."
                            }
                        ],
                        "totalScore": 8.0,
                        "overallFeedback": "Nhận xét tổng quan...",
                        "scorePercentage": 80
                    }
                `;
            }
            
            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            // Tìm và trích xuất JSON từ phản hồi
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}') + 1;
            const jsonString = text.substring(jsonStart, jsonEnd);
            const resultData = JSON.parse(jsonString);
            
            // Thêm thông tin môn học vào kết quả
            resultData.subject = subjectNames[subject];
            
            // Lưu kết quả nếu người dùng đã đăng nhập
            const user = auth.currentUser;
            if (user) {
                try {
                    await db.collection('exam_results').add({
                        userId: user.uid,
                        examData: examData,
                        answers: userAnswers,
                        result: resultData,
                        totalScore: resultData.totalScore,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Lỗi khi lưu kết quả:", error);
                }
            }
            
            return resultData;
        }
        
        // Hiển thị kết quả
        function displayResults(result, subject) {
            // Cập nhật tiêu đề
            resultSubject.textContent = subjectNames[subject];
            resultSubject.className = `subject-${subject}`;
            
            // Tổng điểm
            document.getElementById('total-score').textContent = result.totalScore.toFixed(1);
            
            // Thanh tiến trình
            document.getElementById('score-progress').style.width = `${result.scorePercentage}%`;
            
            // Đánh giá tổng quan
            const scoreFeedback = document.getElementById('score-feedback');
            let feedbackText = "";
            let feedbackClass = "";
            
            if (result.totalScore >= 8) {
                feedbackText = "Kết quả xuất sắc! Bài làm của bạn rất tốt, đáp ứng đầy đủ yêu cầu của đề thi.";
                feedbackClass = "text-green-100";
            } else if (result.totalScore >= 6) {
                feedbackText = "Kết quả khá tốt! Còn một số điểm cần cải thiện để đạt điểm cao hơn.";
                feedbackClass = "text-blue-100";
            } else if (result.totalScore >= 4) {
                feedbackText = "Kết quả trung bình. Bạn cần ôn tập thêm kiến thức và kỹ năng làm bài.";
                feedbackClass = "text-amber-100";
            } else {
                feedbackText = "Kết quả chưa tốt. Bạn cần dành nhiều thời gian hơn để ôn tập và luyện đề.";
                feedbackClass = "text-red-100";
            }
            
            scoreFeedback.textContent = feedbackText;
            scoreFeedback.className = feedbackClass;
            
            // Xóa nội dung cũ
            resultContent.innerHTML = '';
            
            // Tạo nội dung kết quả tùy theo môn
            if (subject === 'literature') {
                // Ngữ Văn
                const readingResults = document.createElement('div');
                readingResults.className = 'mb-8';
                readingResults.innerHTML = `
                    <h4 class="font-bold text-lg mb-4 text-gray-800">I. Đọc hiểu (4.0 điểm)</h4>
                    <div id="reading-feedback" class="space-y-4"></div>
                `;
                resultContent.appendChild(readingResults);
                
                const readingFeedback = document.getElementById('reading-feedback');
                result.reading.questions.forEach(question => {
                    const questionElement = document.createElement('div');
                    
                    // Xác định class kết quả
                    let resultClass = "result-low";
                    if (question.score >= 0.8) resultClass = "result-good";
                    else if (question.score >= 0.5) resultClass = "result-medium";
                    
                    questionElement.className = `result-card ${resultClass} mb-4`;
                    questionElement.innerHTML = `
                        <div class="result-header">
                            <span>Câu ${question.number}</span>
                            <span class="font-bold">${question.score.toFixed(1)} điểm</span>
                        </div>
                        <div class="result-body">
                            <p class="mb-2">${question.feedback}</p>
                            ${question.improvement ? `
                            <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                <p class="font-semibold text-sm text-gray-700 mb-1">Gợi ý cải thiện:</p>
                                <p class="text-sm">${question.improvement}</p>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    readingFeedback.appendChild(questionElement);
                });
                
                const writingResults = document.createElement('div');
                writingResults.innerHTML = `
                    <h4 class="font-bold text-lg mb-4 text-gray-800">II. Làm văn (6.0 điểm)</h4>
                    <div class="mb-6">
                        <h5 class="font-semibold text-gray-700 mb-3">Câu 1: Viết đoạn văn (2.0 điểm)</h5>
                        <div id="writing-1-feedback" class="result-card">
                            <div class="result-header">
                                <span>Điểm số</span>
                                <span id="writing-1-score" class="font-bold">0.0/2.0</span>
                            </div>
                            <div class="result-body">
                                <div id="writing-1-comment" class="mb-3"></div>
                                <div id="writing-1-improvement" class="bg-blue-50 p-3 rounded-lg text-sm"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-semibold text-gray-700 mb-3">Câu 2: Viết bài văn (4.0 điểm)</h5>
                        <div id="writing-2-feedback" class="result-card">
                            <div class="result-header">
                                <span>Điểm số</span>
                                <span id="writing-2-score" class="font-bold">0.0/4.0</span>
                            </div>
                            <div class="result-body">
                                <div id="writing-2-comment" class="mb-3"></div>
                                <div id="writing-2-improvement" class="bg-blue-50 p-3 rounded-lg text-sm"></div>
                            </div>
                        </div>
                    </div>
                `;
                resultContent.appendChild(writingResults);
                
                // Phần làm văn - Câu 1
                const writing1Score = result.writing.task1.score;
                let writing1Class = "result-low";
                if (writing1Score >= 1.6) writing1Class = "result-good";
                else if (writing1Score >= 1.0) writing1Class = "result-medium";
                
                document.getElementById('writing-1-feedback').className = `result-card ${writing1Class}`;
                document.getElementById('writing-1-score').textContent = `${writing1Score.toFixed(1)}/2.0`;
                document.getElementById('writing-1-comment').innerHTML = result.writing.task1.feedback;
                
                if (result.writing.task1.improvement) {
                    document.getElementById('writing-1-improvement').innerHTML = `
                        <p class="font-semibold mb-1">Gợi ý cải thiện:</p>
                        <p>${result.writing.task1.improvement}</p>
                    `;
                } else {
                    document.getElementById('writing-1-improvement').innerHTML = '';
                }
                
                // Phần làm văn - Câu 2
                const writing2Score = result.writing.task2.score;
                let writing2Class = "result-low";
                if (writing2Score >= 3.2) writing2Class = "result-good";
                else if (writing2Score >= 2.0) writing2Class = "result-medium";
                
                document.getElementById('writing-2-feedback').className = `result-card ${writing2Class}`;
                document.getElementById('writing-2-score').textContent = `${writing2Score.toFixed(1)}/4.0`;
                document.getElementById('writing-2-comment').innerHTML = result.writing.task2.feedback;
                
                if (result.writing.task2.improvement) {
                    document.getElementById('writing-2-improvement').innerHTML = `
                        <p class="font-semibold mb-1">Gợi ý cải thiện:</p>
                        <p>${result.writing.task2.improvement}</p>
                    `;
                } else {
                    document.getElementById('writing-2-improvement').innerHTML = '';
                }
            } else {
                // Các môn trắc nghiệm
                result.sections.forEach(section => {
                    const sectionElement = document.createElement('div');
                    sectionElement.className = 'mb-6';
                    
                    // Xác định class kết quả
                    let resultClass = "result-low";
                    const percentage = (section.score / 10) * 100;
                    if (percentage >= 80) resultClass = "result-good";
                    else if (percentage >= 50) resultClass = "result-medium";
                    
                    sectionElement.innerHTML = `
                        <h5 class="font-semibold text-gray-700 mb-3">${section.name}</h5>
                        <div class="result-card ${resultClass}">
                            <div class="result-header">
                                <span>Điểm số</span>
                                <span class="font-bold">${section.score.toFixed(1)}/10</span>
                            </div>
                            <div class="result-body">
                                <p class="mb-2">Số câu đúng: ${section.correct}/${section.total}</p>
                                <p class="mb-3">${section.feedback}</p>
                                ${section.improvement ? `
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-sm text-gray-700 mb-1">Gợi ý cải thiện:</p>
                                    <p class="text-sm">${section.improvement}</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    resultContent.appendChild(sectionElement);
                });
                
                // Đánh giá tổng quan
                const overallFeedback = document.createElement('div');
                overallFeedback.className = 'mt-6 p-4 bg-gray-50 rounded-lg';
                overallFeedback.innerHTML = `
                    <h5 class="font-semibold text-gray-700 mb-2">Đánh giá tổng quan</h5>
                    <p>${result.overallFeedback}</p>
                `;
                resultContent.appendChild(overallFeedback);
            }
        }
        
        // Reset bài thi
        function resetExam() {
            timeLeft = 0;
            examData = null;
            userAnswers = {};
            selectedSubject = null;
            
            // Reset các ô nhập liệu
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.value = '';
            });
            
            // Bỏ chọn tất cả các môn
            subjectSelectors.forEach(s => s.classList.remove('active'));
            
            // Vô hiệu hóa nút bắt đầu thi
            startExamBtn.disabled = true;
            selectedExamTime.textContent = 'Chọn môn để xem thời gian';
        }
    </script>
</body>
</html>